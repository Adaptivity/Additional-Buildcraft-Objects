<project name="Buildcraft" basedir="../" default="main">
	<property name="jgit.version" value="2.0.0.201206130900-r"/>

	<taskdef resource="org/eclipse/jgit/ant/ant-tasks.properties">
		<classpath>
			<pathelement location="ant/org.eclipse.jgit.ant-${jgit.version}.jar"/>
			<pathelement location="ant/org.eclipse.jgit-${jgit.version}.jar"/>
			<pathelement location="ant/jsch-0.1.29.jar"/>
		</classpath>
	</taskdef>	

	<!-- Properties -->
	<property name="build.dir"              value="build"/>
	<property name="abo.dir"                value="abo"/>
	
	<property name="download.dir"           value="download"/>
	<property name="files.minecraft.dir"    value="jars"/>
	
	<property name="classes.dir"            value="${build.dir}/classes"/>
	<property name="jar.dir"                value="${build.dir}/dist"/>
	  
	<property name="mcp.dir"                value="${build.dir}/mcp"/>
	<property name="forge.dir"              value="${mcp.dir}/forge"/>
	<property name="buildcraft.dir"         value="${build.dir}/buildcraft"/>
	  
	<property name="mc.client.dir"          value="${mcp.dir}/src/minecraft"/>
	<property name="mc.server.dir"          value="${mcp.dir}/src/minecraft_server"/>
	  
	<property name="mcp.version"            value="62"/>
	<property name="forge.version"          value="3.3.8.152"/>
	<property name="buildcraft.version"     value="3.1.6.91"/>
	<property name="buildcraft.version.git" value="8187f94ac5db285934e089902002c0d439d9e577"/>
	
	<property name="abo.version"            value="1.0.0"/>
	<property name="abo.version.full"       value="${abo.version}.${BUILD_NUMBER}"/>
	
	<echo message="Starting build for ${abo.version.full} with forge ${forge.version} and buildcraft ${buildcraft.version}"/>
	
	<!-- Targets -->
	
	<target name="clean">
		<delete dir="${build.dir}" failonerror="False" verbose="True"/>
	</target>
	
	<target name="download">
		<echo message="Downloading files into ${download.dir}"/>

		<mkdir dir="${download.dir}"/>
		
		<get src="http://mcp.ocean-labs.de/files/mcp${mcp.version}.zip" dest="${download.dir}" usetimestamp="True" />
		<get src="https://dl.dropbox.com/u/28221422/MinecraftForge/forge-${forge.version}/minecraftforge-src-${forge.version}.zip" dest="${download.dir}" usetimestamp="True" />
		<get src="https://raw.github.com/gist/3028736/fd11487fce1bf3ba070071b1e057d70f43ef8306/mcp.patch" dest="${download.dir}" usetimestamp="True" />
		
		<!-- todo: use buildcraft-src-*.zip as soon as it exists -->
		<git-clone uri="git://github.com/SirSengir/BuildCraft.git" dest="${buildcraft.dir}"/>
		<git-checkout src="${buildcraft.dir}" branch="${buildcraft.version.git}" />
	</target>

	<target name="extract">
		<echo message="Extracting files into ${mcp.dir}"/>
		
		<unzip dest="${mcp.dir}">
			<fileset dir="${download.dir}">
				<include name="mcp${mcp.version}.zip"/>
			</fileset>
		</unzip>
		
		<unzip dest="${mcp.dir}">
			<fileset dir="${download.dir}">
				<include name="minecraftforge-src-${forge.version}.zip"/>
			</fileset>
		</unzip>

		<!-- todo: use buildcraft-src-*.zip as soon as it exists -->
		<!--<unzip dest="${buildcraft.dir}">
			<fileset dir="${download.dir}">
				<include name="buildcraft-src-${buildcraft.version}.zip"/>
			</fileset>
		</unzip>-->
			
		<copy todir="${mcp.dir}/jars">
			<fileset dir="${files.minecraft.dir}"/>
		</copy>
	
		<fixcrlf file="${download.dir}/mcp.patch" eol="crlf" />
		<patch patchfile="${download.dir}/mcp.patch" dir="${mcp.dir}" strip="0" failonerror="True" />
		
		<chmod file="${mcp.dir}/updatemd5.sh" perm="+x"/>
		<chmod file="${mcp.dir}/recompile.sh" perm="+x"/>
		<chmod file="${mcp.dir}/reobfuscate.sh" perm="+x"/>
		<chmod file="${forge.dir}/install.sh" perm="+x"/>
	</target>
	
	<target name="install-forge-src">
		<echo message="Installing forge (calling install.cmd/install.sh)"/>
		<!-- Install forge -->
		<exec dir="${forge.dir}" executable="cmd" osfamily="windows">
			<arg line="/c install.cmd"/>
		</exec>
		
		<exec dir="${forge.dir}" executable="sh" osfamily="unix">
			<arg value="install.sh" />
		</exec>
	</target>

	<target name="install-buildcraft-src">
		<echo message="Installing buildcraft source"/>
		<!-- Copy BC source -->
		<copy todir="${mc.client.dir}">
			<fileset dir="${buildcraft.dir}/buildcraft_client">
				<exclude name="**/buildcraft/mod_*"/>
				<exclude name="**/buildcraft/Build*"/>
			</fileset>
			<fileset dir="${buildcraft.dir}/buildcraft_client/buildcraft">
				<exclude name="mod_*"/>
				<exclude name="Build*"/>
			</fileset>
		</copy>
		<copy todir="${mc.client.dir}">
			<fileset dir="${buildcraft.dir}/common">
				<exclude name="**/buildcraft/mod_*"/>
				<exclude name="**/buildcraft/Build*"/>
				<exclude name="**/buildcraft/devel"/>
			</fileset>
			<fileset dir="${buildcraft.dir}/common/buildcraft">
				<exclude name="mod_*"/>
				<exclude name="Build*"/>
			</fileset>
			<filterset>
				<filter token="VERSION" value="${buildcraft.version}" />
			</filterset>
		</copy>
		
		<copy todir="${mc.server.dir}">
			<fileset dir="${buildcraft.dir}/buildcraft_server">
				<exclude name="**/buildcraft/mod_*"/>
				<exclude name="**/buildcraft/Build*"/>
			</fileset>
			<fileset dir="${buildcraft.dir}/buildcraft_server/buildcraft">
				<exclude name="mod_*"/>
				<exclude name="Build*"/>
			</fileset>
		</copy>
		<copy todir="${mc.server.dir}">
			<fileset dir="${buildcraft.dir}/common">
				<exclude name="**/buildcraft/mod_*"/>
				<exclude name="**/buildcraft/Build*"/>
				<exclude name="**/buildcraft/devel"/>
			</fileset>
			<fileset dir="${buildcraft.dir}/common/buildcraft">
				<exclude name="mod_*"/>
				<exclude name="Build*"/>
			</fileset>
			<filterset>
				<filter token="VERSION" value="${buildcraft.version}" />
			</filterset>
		</copy>
		
		<echo message="Refreshing MD5s"/>

		<!-- Refresh MD5 -->
		<exec dir="${mcp.dir}" executable="cmd" osfamily="windows">
			<arg line="/c updatemd5.bat -f"/>
		</exec>
		
		<exec dir="${mcp.dir}" executable="sh" osfamily="unix">
			<arg line="updatemd5.sh -f" />
		</exec>
	</target>

	<target name="install-abo-src">
		<echo message="Installing ABO source"/>

		<!-- Copy ABO source -->
		<copy todir="${mc.client.dir}">
			<fileset dir="${abo.dir}/client"/>
		</copy>
		<copy todir="${mc.client.dir}">
			<fileset dir="${abo.dir}/common"/>
			<filterset>
				<filter token="VERSION" value="${abo.version} (BC {$buildcraft.version}, Forge {$forge.version})" />
			</filterset>
		</copy>
		
		<copy todir="${mc.server.dir}">
			<fileset dir="${abo.dir}/server"/>
		</copy>
		<copy todir="${mc.server.dir}">
			<fileset dir="${abo.dir}/common"/>
			<filterset>
				<filter token="VERSION" value="${abo.version} (BC {$buildcraft.version}, Forge {$forge.version})" />
			</filterset>
		</copy>
	</target>
	
	<target name="compile-abo">
		<echo message="Compiling ABO"/>

		<!-- Recompile -->
		<exec dir="${mcp.dir}" executable="cmd" osfamily="windows">
			<arg line="/c recompile.bat"/>
		</exec>
		
		<exec dir="${mcp.dir}" executable="sh" osfamily="unix">
			<arg value="recompile.sh" />
		</exec>
		
		<!-- Reobf -->
		<exec dir="${mcp.dir}" executable="cmd" osfamily="windows">
			<arg line="/c reobfuscate.bat"/>
		</exec>
		
		<exec dir="${mcp.dir}" executable="sh" osfamily="unix">
			<arg value="reobfuscate.sh" />
		</exec>
	</target>
	
	<target name="copy-abo">
		<echo message="Copying build results"/>

		<!-- Copy ABO classes -->
		<copy todir="${classes.dir}/client">
			<fileset dir="${mcp.dir}/reobf/minecraft"/>
		</copy>
		<copy todir="${classes.dir}/server">
			<fileset dir="${mcp.dir}/reobf/minecraft_server"/>
		</copy>
	
		<!-- Copy resoucres -->
		<copy todir="${classes.dir}/client">
			<fileset dir="${abo.dir}/resources">
			<exclude name="gui/*/*.psd"/>
			</fileset>
		</copy>
		<copy todir="${classes.dir}/server">
			<fileset dir="${abo.dir}/resources">
			<exclude name="gui/*"/>
			</fileset>
		</copy>
	</target>
	
	<target name="package-abo">
		<echo message="Creating jars"/>
		
		<jar destfile="${jar.dir}/additionalbuildcraft-client-${abo.version.full}.jar" basedir="${classes.dir}/client"/>
		<jar destfile="${jar.dir}/additionalbuildcraft-server-${abo.version.full}.jar" basedir="${classes.dir}/server"/>
	</target>
	
	<target name="main" depends="clean,download,extract,install-forge-src,install-buildcraft-src,install-abo-src,compile-abo,copy-abo,package-abo">
		<echo message="Finished building ABO"/>
	</target>

</project>